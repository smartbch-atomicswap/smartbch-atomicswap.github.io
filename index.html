<!DOCTYPE html>
<html>

<head>
</head>

<body>
    <button onclick="sendData">sendData</button>
    <span id="privateKey"></span>
    <script></script>
    <script>
        let latestMessageData
        async function getMessageResult() {
            return new Promise((resolve) => {
                const fun = () => {
                    if (typeof latestMessageData !== "undefined") {
                        const result = latestMessageData
                        latestMessageData = undefined
                        resolve(latestMessageData)
                        return
                    }
                    setTimeout(fun, 1000);
                }
                fun()
            })
        }

        function sendData() {
            const message = BigInt(Math.random() * 10000)
            const data = { [Math.random.toString()]: message }
            console.log("sendData:", data)
            navigator.serviceWorker.controller.postMessage({ action: "write", data })
        }

        function readData(key) {
            navigator.serviceWorker.controller.postMessage({ action: "read", key });
        }

        let privateKey
        if ('serviceWorker' in navigator) {
            // Register service worker
            navigator.serviceWorker.register('/index-serviceworker.js').then(async function (reg) {
                console.log("SW registration succeeded. Scope is " + reg.scope);

                navigator.serviceWorker.addEventListener('message', function (event) {
                    console.log("event:", event, "Received Message: " + event.data);
                    latestMessageData = event.data
                });

                const _privateKey = await getMessageResult("privateKey")
                if (_privateKey) {
                    privateKey = _privateKey
                    document.querySelector('#privateKey').textContent = privateKey
                } else {
                    const data = { action: "write", data: { privateKey: "privateKey" } }
                    navigator.serviceWorker.controller.postMessage(data)
                }
            }).catch(function (err) {
                console.error("SW registration failed with error " + err);
            });
        }

        // window.addEventListener("message", async function (event) {
        //     console.log("parent message:", message)
        //     if (message.action === "getAccount") {
        //         window.parent.postMessage(await getMessageResult(), '\*');
        //     }
        // })

    </script>
</body>

</html>